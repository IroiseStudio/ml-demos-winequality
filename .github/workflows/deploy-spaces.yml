name: Deploy to Hugging Face Spaces

on:
  push:
    branches: [main]
    paths:
      - 'DecisionTree/**'
      - 'RandomForest/**'
      - 'MultiLayerPerceptron/**'
      - 'SupportVectorMachine/**'
      - 'NaiveBayes/**'
      - 'LinearRegression/**'
  workflow_dispatch:

jobs:
  deploy-demos:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        demo:
          - name: DecisionTree
            space: AlbanDelamarre/DT_WineQuality
            path: DecisionTree
          - name: RandomForest
            space: AlbanDelamarre/RF_WineQuality
            path: RandomForest
          - name: MultiLayerPerceptron
            space: AlbanDelamarre/MLP_WineQuality
            path: MultiLayerPerceptron
          - name: SupportVectorMachine
            space: AlbanDelamarre/SVM_WineQuality
            path: SupportVectorMachine
          - name: NaiveBayes
            space: AlbanDelamarre/NB_WineQuality
            path: NaiveBayes
          - name: LinearRegression
            space: AlbanDelamarre/LR_WineQuality
            path: LinearRegression

    steps:
      - name: Checkout repo (with LFS)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Prepare workspace for ${{ matrix.demo.name }}
        run: |
          rm -rf out && mkdir -p out
          rsync -av --delete "${{ matrix.demo.path }}/" out/
          ls -la out

      - name: Init Git for Space content
        working-directory: out
        run: |
          git init
          git config user.email "actions@github.com"
          git config user.name "github-actions[bot]"
          git lfs install || true
          git add .
          git commit -m "CI: deploy ${{ matrix.demo.name }} from GitHub"

      - name: Push to Hugging Face Space
        working-directory: out
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          git remote add space https://huggingface.co/spaces/${{ matrix.demo.space }}
          git push --force "https://oauth2:${HF_TOKEN}@huggingface.co/spaces/${{ matrix.demo.space }}" HEAD:main
